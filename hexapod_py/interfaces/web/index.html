<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexapod Control</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.1/nipplejs.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Hexapod Web Controller</h1>
            <p>Mode: <span id="mode">{{ mode }}</span></p>
        </header>

        <main>
            <!-- Main View and Previews will be dynamically inserted here by main.js -->
            <div class="view-container">
                <div id="main-view"></div>
                <div id="preview-container"></div>
            </div>

            <div class="controls-container">
                <div class="joysticks-wrapper">
                    <div class="joystick-area">
                        <div id="joystick-zone-left" class="joystick-zone"></div>
                        <p>Movement (vx, vy)</p>
                    </div>
                    <div class="joystick-area">
                        <div id="joystick-zone-right" class="joystick-zone"></div>
                        <p>Rotation (omega)</p>
                    </div>
                </div>
                <button id="emergency-stop-btn" class="emergency-stop">TOGGLE LOCOMOTION</button>
            </div>
        </main>

        <footer>
            <p>Sensor Data</p>
            <pre id="sensor-data">Fetching sensor data...</pre>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Control State ---
            let controlState = {
                vx: 0,
                vy: 0,
                omega: 0,
            };
            let sendInterval;

            // --- Network Functions ---
            function sendMoveCommand() {
                fetch('/move', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(controlState)
                }).catch(console.error);
                // console.log("Sending:", controlState);
            }

            function toggleLocomotion() {
                fetch('/toggle_locomotion', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => console.log("Locomotion status:", data.status))
                    .catch(console.error);
            }

            // --- Joystick Initialization ---
            const joystickOptions = {
                mode: 'static',
                color: '#007bff',
                size: 150,
                threshold: 0.1,
                fadeTime: 250
            };

            // Left Joystick (Movement)
            const joystickLeftZone = document.getElementById('joystick-zone-left');
            const joystickLeft = nipplejs.create({ ...joystickOptions, zone: joystickLeftZone, position: { left: '50%', top: '50%' } });

            joystickLeft.on('start end', (evt, data) => {
                // Reset on start/end
                controlState.vx = 0;
                controlState.vy = 0;
                if (evt.type === 'start') {
                    startSendingInterval();
                } else {
                    stopSendingInterval();
                }
            }).on('move', (evt, data) => {
                if (data.distance > 0) {
                    const angle = data.angle.radian;
                    const normalizedDistance = data.distance / (joystickOptions.size / 2);
                    // Note: nipplejs Y is up, which is what we want for forward (vy)
                    controlState.vx = Math.cos(angle) * normalizedDistance;
                    controlState.vy = Math.sin(angle) * normalizedDistance;
                }
            });

            // Right Joystick (Rotation & Height)
            const joystickRightZone = document.getElementById('joystick-zone-right');
            const joystickRight = nipplejs.create({ ...joystickOptions, zone: joystickRightZone, position: { left: '50%', top: '50%' } });

            joystickRight.on('start end', (evt, data) => {
                // Reset only omega on start/end, keep height
                controlState.omega = 0;
                if (evt.type === 'start') {
                    startSendingInterval();
                } else {
                    stopSendingInterval();
                }
            }).on('move', (evt, data) => {
                if (data.distance > 0) {
                    const normalizedX = data.vector.x;
                    // X-axis for rotation
                    controlState.omega = -normalizedX; // Invert for intuitive control
                }
            });

            // --- Control Loop ---
            function startSendingInterval() {
                if (!sendInterval) {
                    sendMoveCommand(); // Send immediately
                    sendInterval = setInterval(sendMoveCommand, 100); // Then every 100ms
                }
            }

            function stopSendingInterval() {
                clearInterval(sendInterval);
                sendInterval = null;
                sendMoveCommand(); // Send final state
            }

            // --- Event Listeners ---
            document.getElementById('emergency-stop-btn').addEventListener('click', toggleLocomotion);

            // --- Sensor Data Fetching ---
            function fetchSensorData() {
                fetch('/sensor_data')
                    .then(response => response.json())
                    .then(data => {
                        const sensorPre = document.getElementById('sensor-data');
                        sensorPre.textContent = JSON.stringify(data, null, 2);
                    })
                    .catch(error => {
                        document.getElementById('sensor-data').textContent = 'Error fetching sensor data. Is the platform server running?';
                        console.error('Error:', error);
                    });
            }

            setInterval(fetchSensorData, 1000); // Update every second
            fetchSensorData(); // Initial fetch
        });
    </script>
</body>
</html>